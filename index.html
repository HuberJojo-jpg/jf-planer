<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JF Ehingen Verwaltung Cloud</title>
    <link rel="apple-touch-icon" href="https://www.fw-ehingen.de/wp-content/themes/theke-fire/img/fw-logo.svg">
    <link rel="icon" type="image/png" href="https://www.fw-ehingen.de/wp-content/themes/theke-fire/img/fw-logo.svg">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <style>
        :root { --fire-red: #e10000; --light-bg: #f4f4f4; --dark-bg: #121212; --dark-card: #1e1e1e; }
        body { font-family: -apple-system, system-ui, sans-serif; margin: 0; background: var(--light-bg); transition: 0.3s; color: #333; }
        
        #authContainer { position: fixed; top:0; left:0; width:100%; height:100%; background: #e10000; z-index: 2000; display: flex; align-items: center; justify-content: center; }
        .auth-box { background: white; padding: 30px; border-radius: 15px; width: 300px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .auth-box input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        #mainApp { display: none; }

        /* --- BASIS DARK MODE --- */
        body.dark-mode { background: var(--dark-bg) !important; color: #e0e0e0 !important; }
        body.dark-mode .header-nav, 
        body.dark-mode .controls, 
        body.dark-mode .table-container, 
        body.dark-mode .config-box, 
        body.dark-mode .modal-content,
        body.dark-mode table { background: var(--dark-card) !important; border-color: #444 !important; color: white !important; }
        
        body.dark-mode th, body.dark-mode td { background: var(--dark-card) !important; border-color: #444 !important; }
        body.dark-mode input, body.dark-mode textarea { background: #2a2a2a !important; color: white !important; border: 1px solid #555 !important; }
        body.dark-mode .tab { background: #333; border-color: #444; color: #aaa; }
        body.dark-mode .tab.active { background: var(--fire-red) !important; color: white !important; border-top-color: var(--fire-red); }
        body.dark-mode .sticky-col { background-color: var(--dark-card) !important; border-right: 3px solid #555 !important; }

        /* --- STATUS FARBEN --- */
        td.status-A, body.dark-mode td.status-A { background-color: #c3e6cb !important; color: #155724 !important; }
        td.status-E, body.dark-mode td.status-E { background-color: #ffeeba !important; color: #856404 !important; }
        td.status-U, body.dark-mode td.status-U { background-color: #f5c6cb !important; color: #721c24 !important; }
        
        body.dark-mode td.status-A, body.dark-mode td.status-A select { background-color: #1b4332 !important; color: #d8f3dc !important; }
        body.dark-mode td.status-E, body.dark-mode td.status-E select { background-color: #5d4a1b !important; color: #ffea00 !important; }
        body.dark-mode td.status-U, body.dark-mode td.status-U select { background-color: #641220 !important; color: #ffccd5 !important; }

        /* --- LAYOUT --- */
        .header-nav { background: white; padding: 10px 15px; display: flex; align-items: center; gap: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .logo-img { height: 40px; width: auto; }
        .sidebar { height: 100%; width: 0; position: fixed; z-index: 3000; top: 0; left: 0; background: #222; overflow-x: hidden; transition: 0.3s; padding-top: 60px; }
        .sidebar a { padding: 15px 25px; color: white; display: block; text-decoration: none; font-size: 18px; cursor: pointer; }
        .view-section { display: none; padding: 15px; }
        .view-section.active { display: block; }
        .controls { background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }

        .tab-container { display: flex; gap: 4px; }
        .tab { padding: 12px 20px; background: #ddd; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: bold; border: 1px solid #ccc; border-bottom: none; color: #666; }
        .tab.active { background: white; color: var(--fire-red); border-top: 3px solid var(--fire-red); }

        .table-container { background: white; padding: 8px; border-radius: 0 10px 10px 10px; overflow-x: auto; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); }
        table { border-collapse: separate; border-spacing: 0; min-width: 100%; table-layout: fixed; }
        
        th, td { border: 1px solid #ddd; padding: 5px; text-align: center; height: 50px; vertical-align: middle; position: relative; }
        th { height: 85px; } 

        /* Themen-Eingabe mittig */
        th input[type="text"] { text-align: center !important; }
        
        .sticky-col { position: sticky; left: 0; z-index: 100; width: 180px; min-width: 180px; background-color: white !important; border-right: 3px solid #bbb !important; }
        .sticky-col input { width: 90%; border: none; background: transparent; font-weight: bold; color: inherit; text-align: center; outline: none; cursor: default; font-size: 18px; }

        .status-cell { padding: 0 !important; width: 65px; }
        .att-select { width: 100%; height: 100%; min-height: 48px; border: none; background: transparent; font-weight: bold; cursor: pointer; text-align: center; text-align-last: center; color: inherit; appearance: none; display: block; font-size: 16px; }
        
        /* Inventar Textarea Anpassung */
        #inventoryBody td { padding: 0; }
        #inventoryBody textarea { width: 100%; height: 100%; min-height: 50px; border: none; background: transparent; box-sizing: border-box; display: block; padding: 8px; font-family: inherit; font-size: inherit; color: inherit; resize: none; }

        .modal { display: none; position: fixed; z-index: 5000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(3px); }
        .modal-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border-radius: 15px; width: 320px; text-align: center; }
        
        /* Termin-Datum mittig und kleiner */
        #newDateInput { width: 80%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; display: block; margin: 0 auto 15px auto; font-size: 16px; text-align: center; }

        .btn-green { background: #28a745; } .btn-red { background: #dc3545; } .btn-blue { background: #007bff; } .btn-gray { background: #6c757d; } .btn-orange { background: #fd7e14; } .btn-cyan { background: #17a2b8; }
        button { padding: 10px 14px; border: none; border-radius: 8px; font-weight: bold; color: white; cursor: pointer; margin: 2px; }
    </style>
</head>
<body>

    <div id="authContainer">
        <div class="auth-box">
            <img src="https://www.fw-ehingen.de/wp-content/themes/theke-fire/img/fw-logo.svg" style="height:70px; margin-bottom:15px;">
            <h2 style="margin:0 0 20px 0">JF Ehingen Cloud</h2>
            <input type="email" id="email" placeholder="E-Mail">
            <input type="password" id="password" placeholder="Passwort">
            <button class="btn-red" style="width:100%" onclick="window.handleLogin()">Anmelden</button>
            <p id="loginError" style="color:red; display:none;"></p>
        </div>
    </div>

    <div id="mainApp">
        <div class="header-nav">
            <span onclick="window.openNav()" style="font-size:25px; cursor:pointer; color:red">‚ò∞</span>
            <img src="https://www.fw-ehingen.de/wp-content/themes/theke-fire/img/fw-logo.svg" class="logo-img">
            <strong style="margin-left:10px; color:red">JF Ehingen Cloud</strong>
        </div>

        <div id="mySidebar" class="sidebar">
            <a onclick="window.closeNav()" style="font-size:30px; position:absolute; right:20px; top:10px">√ó</a>
            <a onclick="window.showSection('dienstplan')">üìÖ Dienstplan</a>
            <a onclick="window.showSection('inventar')">üì¶ Inventar</a>
            <a onclick="window.toggleDarkMode()">üåì Dark Mode</a>
            <a onclick="window.handleLogout()" style="color: #ff4d4d; margin-top:30px">üö™ Abmelden</a>
        </div>

        <div class="main-content">
            <section id="dienstplan" class="view-section active">
                <div class="controls">
                    <input type="text" id="nameInput" placeholder="Name..." style="padding:10px" onkeydown="if(event.key === 'Enter') window.addMember()">
                    <button class="btn-green" onclick="window.addMember()">‚ûï</button>
                    <button class="btn-orange" onclick="window.addSpecialColumn()">‚òëÔ∏è Liste</button>
                    <button class="btn-cyan" onclick="window.openDateModal()">üìÖ Termin+</button>
                    <button class="btn-blue" onclick="window.exportDienstplanCSV()">Export</button>
                    <button class="btn-gray" onclick="window.toggleConfig()">‚öôÔ∏è Setup</button>
                    <div id="configSection" class="config-box" style="display:none; padding:15px; width:100%">
                        <textarea id="ferienInput">2026-12-23 bis 2026-12-31</textarea>
                        <button class="btn-red" onclick="window.rebuildCalendar()">üîÑ Kalender generieren</button>
                    </div>
                </div>

                <div class="tab-container">
                    <div id="tab-Kleine" class="tab active" onclick="window.switchTab('Kleine')">Kleine</div>
                    <div id="tab-Gro√üe" class="tab" onclick="window.switchTab('Gro√üe')">Gro√üe</div>
                    <div id="tab-Betreuer" class="tab" onclick="window.switchTab('Betreuer')">Betreuer</div>
                </div>
                <div class="table-container">
                    <table>
                        <thead id="headerRow"></thead>
                        <tbody id="memberBody"></tbody>
                        <tfoot id="footerRow"></tfoot>
                    </table>
                </div>
            </section>

            <section id="inventar" class="view-section">
                <div class="controls">
                    <input type="text" id="itemInput" placeholder="Neuer Gegenstand..." style="flex-grow:1; padding:10px" onkeydown="if(event.key === 'Enter') window.addInventoryItem()">
                    <button class="btn-green" onclick="window.addInventoryItem()">‚ûï</button>
                </div>
                <div class="table-container">
                    <table><thead><tr><th>Gegenstand</th><th style="width:60px">Anz.</th><th>Verliehen</th><th>Kommentare</th><th style="width:50px">üóëÔ∏è</th></tr></thead><tbody id="inventoryBody"></tbody></table>
                </div>
            </section>
        </div>
    </div>

    <div id="dateModal" class="modal">
        <div class="modal-content">
            <h3>Neuer Termin</h3>
            <input type="date" id="newDateInput">
            <button class="btn-green" onclick="window.addManualDate()">Hinzuf√ºgen</button>
            <button class="btn-gray" onclick="window.closeDateModal()">Abbrechen</button>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAp8O_pbGENpRl4QL5qawF5QLTXJKSz5k8",
        authDomain: "jf-verwaltung-a8aa0.firebaseapp.com",
        projectId: "jf-verwaltung-a8aa0",
        storageBucket: "jf-verwaltung-a8aa0.firebasestorage.app",
        messagingSenderId: "910658603721",
        appId: "1:910658603721:web:6af4b03bb12f70c5701b18"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const docRef = doc(db, "verwaltung", "ehingen_master");

    let state = { dates: [], members: [], currentTab: 'Kleine', inventory: [], specials: [], darkMode: false };
    let saveTimeout = null;

    const deToIso = (de) => de.split('.').reverse().join('-');

    window.handleLogin = () => {
        signInWithEmailAndPassword(auth, email.value, password.value).catch(e => loginError.style.display="block");
    };
    window.handleLogout = () => signOut(auth);

    onAuthStateChanged(auth, (user) => {
        if (user) {
            authContainer.style.display = 'none';
            mainApp.style.display = 'block';
            onSnapshot(docRef, (doc) => {
                if (doc.exists()) {
                    state = doc.data();
                    if(state.darkMode) document.body.classList.add('dark-mode');
                    else document.body.classList.remove('dark-mode');
                    window.render(); window.renderInventory();
                }
            });
        } else {
            authContainer.style.display = 'flex';
            mainApp.style.display = 'none';
        }
    });

    window.save = async () => await setDoc(docRef, state);

    window.updateTopic = (idx, val) => {
        state.dates[idx].t = val;
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(async () => {
            await updateDoc(docRef, { dates: state.dates });
        }, 2000);
    };

    // Kalender f√ºr beliebiges Jahr generieren
    window.rebuildCalendar = () => {
        const yearInput = prompt("F√ºr welches Jahr soll der Kalender generiert werden?", "2026");
        if(!yearInput) return;
        const targetYear = parseInt(yearInput);

        if(!confirm(`Kalender f√ºr ${targetYear} generieren? ACHTUNG: Dabei werden ALLE bisherigen Anwesenheiten gel√∂scht!`)) return;

        state.members.forEach(m => { m.attendance = {}; });
        state.dates = [];

        let d = new Date(`${targetYear}-01-01T12:00:00`);
        while (d.getDay() !== 2) { 
            d.setDate(d.getDate() + 1);
        }

        const ferien = document.getElementById('ferienInput').value;
        while(d.getFullYear() === targetYear) {
            const dStr = d.toISOString().split('T')[0];
            const isFerien = ferien.split('\n').some(z => {
                const p = z.split(' bis ');
                return p.length === 2 && dStr >= p[0].trim() && dStr <= p[1].trim();
            });
            if(!isFerien) {
                const formatted = dStr.split('-').reverse().join('.');
                state.dates.push({ d: formatted, t: "" });
            }
            d.setDate(d.getDate() + 7);
        }
        window.save();
    };

    window.render = () => {
        const h = document.getElementById('headerRow'); const b = document.getElementById('memberBody'); const f = document.getElementById('footerRow');
        if(!h || !b || !f) return;
        state.dates.sort((a,b) => deToIso(a.d).localeCompare(deToIso(b.d)));

        let hHtml = `<tr><th class="sticky-col">Name</th><th style="width:40px">A</th><th style="width:40px">E</th><th style="width:40px">U</th><th style="width:45px">%</th>`;
        state.specials?.forEach((s, i) => hHtml += `<th style="width:100px; font-size:12px;">${s}<br><span onclick="window.removeSpecial(${i})" style="color:red; cursor:pointer;">‚úï</span></th>`);
        state.dates.forEach((d, i) => {
            hHtml += `<th style="width:130px; font-size:13px;">${d.d}<br><input type="text" id="topic-${i}" value="${d.t || ''}" oninput="window.updateTopic(${i}, this.value)" onchange="window.save()"><br><span onclick="window.removeDate(${i})" style="color:red; cursor:pointer; font-size:11px">‚úï</span></th>`;
        });
        h.innerHTML = hHtml + '<th style="width:50px">üóëÔ∏è</th></tr>';

        const filtered = state.members.filter(m => m.category === state.currentTab).sort((a,b) => a.name.localeCompare(b.name, 'de'));
        b.innerHTML = filtered.map(m => {
            const mIdx = state.members.findIndex(x => x.id === m.id);
            const att = Object.values(m.attendance || {});
            const aCount = att.filter(v=>v==='A').length;
            let row = `<td class="sticky-col"><input type="text" value="${m.name}" readonly></td><td style="font-weight:bold">${aCount}</td><td>${att.filter(v=>v==='E').length}</td><td>${att.filter(v=>v==='U').length}</td><td>${att.length ? Math.round((aCount/att.length)*100) : 0}%</td>`;
            state.specials?.forEach((_, sI) => row += `<td class="special-cell"><input type="checkbox" ${m.specialStates?.[sI] ? 'checked' : ''} onchange="window.toggleSpecialDirect(${mIdx}, ${sI})"></td>`);
            row += state.dates.map(d => `<td class="status-cell status-${m.attendance?.[d.d] || '-'}"><select class="att-select" onchange="window.updateAtt('${mIdx}','${d.d}',this.value)"><option value="-" ${(m.attendance?.[d.d]||'-')==='-'?'selected':''}>-</option><option value="A" ${m.attendance?.[d.d]==='A'?'selected':''}>A</option><option value="E" ${m.attendance?.[d.d]==='E'?'selected':''}>E</option><option value="U" ${m.attendance?.[d.d]==='U'?'selected':''}>U</option></select></td>`).join('');
            return `<tr>${row}<td><button class="btn-red" onclick="window.deleteMember(${mIdx})">üóëÔ∏è</button></td></tr>`;
        }).join('');

        let fHtml = `<tr><td class="sticky-col">Gesamt</td><td></td><td></td><td></td><td></td>`;
        state.specials?.forEach((_, sI) => fHtml += `<td style="font-size:12px; font-weight:bold; color:#fd7e14;">${filtered.reduce((acc, m) => (m.specialStates?.[sI] ? acc + 1 : acc), 0)} / ${filtered.length}</td>`);
        state.dates.forEach(d => fHtml += `<td style="font-size:18px; font-weight:bold">${filtered.reduce((acc, m) => (m.attendance?.[d.d] === 'A' ? acc + 1 : acc), 0)}</td>`);
        f.innerHTML = fHtml + "<td></td></tr>";
    };

    window.updateAtt = (mIdx, date, val) => { if(!state.members[mIdx].attendance) state.members[mIdx].attendance = {}; state.members[mIdx].attendance[date] = val; window.save(); };
    window.addMember = () => { if(!nameInput.value) return; state.members.push({ id: Date.now(), name: nameInput.value, category: state.currentTab, attendance: {}, specialStates: [] }); nameInput.value = ""; window.save(); };
    window.deleteMember = (idx) => { if (confirm("L√∂schen?")) { state.members.splice(idx, 1); window.save(); } };
    
    window.removeDate = (i) => { 
        if(confirm("Diesen Termin und alle zugeh√∂rigen Anwesenheiten wirklich l√∂schen?")) { 
            const dateToDelete = state.dates[i].d; 
            state.dates.splice(i, 1); 
            state.members.forEach(m => { if(m.attendance) delete m.attendance[dateToDelete]; }); 
            window.save(); 
        } 
    };

    window.addSpecialColumn = () => { const t = prompt("Name:"); if(t) { state.specials = state.specials || []; state.specials.push(t); window.save(); } };
    window.removeSpecial = (i) => { if(confirm("L√∂schen?")) { state.specials.splice(i, 1); state.members.forEach(m => m.specialStates?.splice(i, 1)); window.save(); } };
    window.toggleSpecialDirect = (mIdx, sI) => { if(!state.members[mIdx].specialStates) state.members[mIdx].specialStates = []; state.members[mIdx].specialStates[sI] = !state.members[mIdx].specialStates[sI]; window.save(); };
    window.renderInventory = () => { inventoryBody.innerHTML = state.inventory.sort((a,b)=>(a.name||"").localeCompare(b.name||"")).map(item => `<tr><td><input type="text" class="inv-input" value="${item.name||''}" onchange="window.updateInvField('${item.id}','name',this.value)"></td><td><input type="text" class="inv-input" value="${item.amount||''}" style="width:50px" onchange="window.updateInvField('${item.id}','amount',this.value)"></td><td><input type="date" class="inv-input" value="${item.loanDate||''}" onchange="window.updateInvField('${item.id}','loanDate',this.value)"></td><td><textarea onchange="window.updateInvField('${item.id}','log',this.value)">${item.log||''}</textarea></td><td><button class="btn-red" onclick="window.deleteInv('${item.id}')">üóëÔ∏è</button></td></tr>`).join(''); };
    window.updateInvField = (id, f, v) => { const i = state.inventory.find(x=>x.id==id); if(i){i[f]=v; window.save();} };
    window.deleteInv = (id) => { if(confirm("L√∂schen?")){state.inventory=state.inventory.filter(x=>x.id!=id); window.save();} };
    window.addInventoryItem = () => { if(!itemInput.value) return; state.inventory.push({id:Date.now(), name:itemInput.value, amount:"1"}); itemInput.value=""; window.save(); };
    
    window.exportDienstplanCSV = () => {
        let csv = "\ufeffName;Gruppe;A;E;U;Quote;";
        state.specials?.forEach(s => csv += s + ";");
        state.dates.forEach(d => csv += `${d.d};`);
        csv += "\n";
        const catOrder = { 'Kleine': 1, 'Gro√üe': 2, 'Betreuer': 3 };
        [...state.members].sort((a,b) => catOrder[a.category] - catOrder[b.category] || a.name.localeCompare(b.name)).forEach(m => {
            const atts = Object.values(m.attendance || {});
            csv += `${m.name};${m.category};${atts.filter(v=>v==='A').length};${atts.filter(v=>v==='E').length};${atts.filter(v=>v==='U').length};${atts.length?Math.round((atts.filter(v=>v==='A').length/atts.length)*100):0}%;`;
            state.specials?.forEach((_, i) => csv += (m.specialStates?.[i] ? "JA" : "NEIN") + ";");
            state.dates.forEach(d => csv += (m.attendance?.[d.d] || "-") + ";");
            csv += "\n";
        });
        const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); link.download = "Export.csv"; link.click();
    };

    window.switchTab = (t) => { 
        state.currentTab = t; 
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + t).classList.add('active');
        window.render(); 
    };

    window.toggleDarkMode = () => { state.darkMode = !state.darkMode; window.save(); };
    window.showSection = (id) => { document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); };
    window.openNav = () => mySidebar.style.width = "250px";
    window.closeNav = () => mySidebar.style.width = "0";
    window.toggleConfig = () => configSection.style.display = configSection.style.display==='none'?'block':'none';
    window.openDateModal = () => dateModal.style.display = 'block';
    window.closeDateModal = () => dateModal.style.display = 'none';
    window.addManualDate = () => { if(newDateInput.value) { state.dates.push({ d: newDateInput.value.split('-').reverse().join('.'), t: "" }); window.closeDateModal(); window.save(); } };
</script>
</body>
</html>
