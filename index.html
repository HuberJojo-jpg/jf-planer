<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JF Ehingen Planer</title>
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/491/491410.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        :root { --fire-red: #e10000; --dark-gray: #333; --light-gray: #f4f4f4; }
        
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 10px; background-color: var(--light-gray); color: #333; line-height: 1.4; }
        
        /* Controls-Bereich optimiert f√ºr Mobile */
        .controls { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 15px; display: flex; gap: 8px; flex-wrap: wrap; }
        .controls h2 { font-size: 1.2rem; color: var(--fire-red); margin: 0 0 10px 0; width: 100%; text-align: center; }
        
        input[type="text"], input[type="number"], textarea { padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; /* Verhindert Auto-Zoom auf iOS */ }
        #nameInput { flex-grow: 1; min-width: 150px; }

        button { padding: 10px 14px; border: none; border-radius: 8px; font-weight: bold; color: white; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; transition: opacity 0.2s; }
        .btn-green { background: #28a745; }
        .btn-blue { background: #007bff; }
        .btn-yellow { background: #ffc107; color: black; }
        .btn-red { background: #dc3545; }
        .btn-gray { background: #6c757d; }
        .btn-orange { background: #fd7e14; }
        .btn-purple { background: #6f42c1; }

        /* Tabs */
        .tab-container { display: flex; gap: 4px; margin-bottom: -1px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .tab { padding: 12px 18px; background: #ddd; border-radius: 10px 10px 0 0; cursor: pointer; font-weight: bold; color: #555; white-space: nowrap; border: 1px solid #ccc; border-bottom: none; }
        .tab.active { background: white; color: var(--fire-red); border-bottom: 2px solid white; z-index: 2; }

        /* TABELLE MIT FIXIERTER SPALTE */
        .table-container { background: white; padding: 5px; border-radius: 0 12px 12px 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow-x: auto; position: relative; border-top: 1px solid #ccc; }
        table { border-collapse: collapse; min-width: 100%; font-size: 13px; }
        
        th, td { border: 1px solid #ddd; padding: 6px 4px; text-align: center; height: 44px; /* Touch-freundliche H√∂he */ }
        th { background: #444; color: white; vertical-align: top; }

        /* Erste Spalte (Name) fixieren */
        td:first-child, th:first-child { 
            position: sticky; left: 0; z-index: 20; background: white; min-width: 130px; max-width: 130px;
            text-align: left; font-weight: bold; border-right: 2px solid #bbb; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        th:first-child { background: #222; z-index: 21; color: white; }

        /* Checkbox-Spalten */
        th.special-col { background: #0056b3; min-width: 80px; max-width: 100px; }
        .special-title-input { background: transparent; border: none; color: white; font-size: 10px; text-align: center; width: 100%; resize: none; line-height: 1.2; padding: 0; hyphens: auto; }

        /* Termin-Spalten */
        .header-input { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; text-align: center; font-size: 11px; padding: 3px; width: 80px; border-radius: 4px; }
        
        .stat-col { background: #f0f0f0; font-weight: bold; min-width: 35px; }
        .status-A { background-color: #d4edda !important; }
        .status-E { background-color: #fff3cd !important; }
        .status-U { background-color: #f8d7da !important; }
        
        select { border: none; background: transparent; width: 100%; height: 100%; font-size: 14px; font-weight: bold; cursor: pointer; text-align-last: center; -webkit-appearance: none; }
        
        .delete-btn { color: #ccc; font-size: 12px; margin-left: 5px; cursor: pointer; }
        .date-delete { color: #ff8888; font-size: 16px; cursor: pointer; display: block; margin-top: 4px; }

        /* Konfig Bereich */
        .config-section div { margin-bottom: 10px; }

        @media (max-width: 600px) {
            body { margin: 5px; }
            .controls { padding: 10px; }
            button { flex-grow: 1; padding: 12px 8px; }
            td:first-child, th:first-child { min-width: 100px; max-width: 100px; font-size: 12px; }
        }
    </style>
</head>
<body>

    <div class="controls">
        <h2>üöí JF Ehingen Planer</h2>
        <input type="text" id="nameInput" placeholder="Name eingeben..." onkeypress="if(event.key === 'Enter') addMember()">
        <button class="btn-green" onclick="addMember()">‚ûï Hinzuf√ºgen</button>
        <button class="btn-orange" onclick="addSpecialColumn()">‚òëÔ∏è Liste</button>
        <button class="btn-yellow" onclick="addManualDate()">üìÖ Termin</button>
        <button class="btn-blue" onclick="exportCSV()">üíæ CSV</button>
        <button class="btn-gray" onclick="toggleConfig()">‚öôÔ∏è Setup</button>
    </div>

    <div id="configSection" class="config-section">
        <h3>Einstellungen & Backup</h3>
        <div>Jahr: <input type="number" id="cfgYear" value="2026" style="width: 80px;"> <button class="btn-red" onclick="rebuildCalendar()" style="display:inline-block; padding: 5px;">Neu generieren</button></div>
        <hr>
        <div style="display:flex; gap:10px;">
            <button class="btn-purple" onclick="createBackup()" style="flex:1;">Backup Code kopieren</button>
            <button class="btn-blue" onclick="importBackup()" style="flex:1;">Backup einspielen</button>
        </div>
        <button class="btn-red" onclick="resetAll()" style="margin-top:10px; width:100%;">‚ö†Ô∏è Alles l√∂schen</button>
    </div>

    <div class="tab-container">
        <div class="tab active" onclick="switchTab('Kleine')">Kleine</div>
        <div class="tab" onclick="switchTab('Gro√üe')">Gro√üe</div>
        <div class="tab" onclick="switchTab('Betreuer')">Betreuer</div>
    </div>

    <div class="table-container">
        <table id="mainTable">
            <thead><tr id="headerRow"></tr></thead>
            <tbody id="memberBody"></tbody>
            <tfoot><tr id="sumRow" class="sum-row"></tr></tfoot>
        </table>
    </div>

    <script>
        let state = { year: 2026, ferienRaw: "2025-12-22 bis 2026-01-06\n2026-07-30 bis 2026-09-11", dates: [], specials: [], members: [], currentTab: 'Kleine' };
        const STORAGE_KEY = 'jf_ehingen_vFinal_Mobile';

        function init() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) { 
                state = JSON.parse(saved); 
                document.getElementById('cfgYear').value = state.year;
            } else { 
                rebuildCalendar(false); 
            }
            switchTab(state.currentTab);
        }

        function switchTab(tab) {
            state.currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.innerText === tab));
            render();
        }

        function render() {
            state.members.sort((a,b) => a.name.localeCompare(b.name, 'de'));
            state.dates.sort((a,b) => {
                const pA = a.d.split('.'); const pB = b.d.split('.');
                return new Date(pA[2], pA[1]-1, pA[0]) - new Date(pB[2], pB[1]-1, pB[0]);
            });

            const header = document.getElementById('headerRow');
            const body = document.getElementById('memberBody');
            const footer = document.getElementById('sumRow');

            // Header
            header.innerHTML = `<th>Name</th><th class="stat-header">A</th><th class="stat-header">E</th><th class="stat-header">U</th>`;
            state.specials.forEach((s, i) => {
                header.innerHTML += `<th class="special-col">
                    <span class="delete-btn" onclick="removeSpecialCol(${i})">‚úï</span>
                    <textarea class="special-title-input" onchange="editSpec(${i}, this.value)">${s}</textarea>
                </th>`;
            });
            state.dates.forEach((d, i) => {
                header.innerHTML += `<th>
                    <input type="text" value="${d.d}" onchange="editDate(${i}, 'd', this.value)" class="header-input" style="font-weight:bold;"><br>
                    <input type="text" value="${d.t}" placeholder="..." onchange="editDate(${i}, 't', this.value)" class="header-input">
                    <span class="date-delete" onclick="removeDate(${i})">üóëÔ∏è</span>
                </th>`;
            });

            // Body
            body.innerHTML = '';
            let dateSums = new Array(state.dates.length).fill(0);
            state.members.filter(m => m.category === state.currentTab).forEach((m) => {
                const gIdx = state.members.indexOf(m);
                const sA = m.attendance.filter(a => a === 'A').length;
                const sE = m.attendance.filter(a => a === 'E').length;
                const sU = m.attendance.filter(a => a === 'U').length;

                let row = `<tr><td>${m.name} <span class="delete-btn" onclick="deleteMember(${gIdx})">‚úï</span></td>
                           <td class="stat-col">${sA}</td><td class="stat-col">${sE}</td><td class="stat-col">${sU}</td>`;
                
                state.specials.forEach((_, sIdx) => {
                    row += `<td><input type="checkbox" ${m.specialStates[sIdx] ? 'checked' : ''} onchange="updateSpec(${gIdx}, ${sIdx}, this.checked)"></td>`;
                });

                state.dates.forEach((_, dIdx) => {
                    const val = m.attendance[dIdx] || '-';
                    if(val === 'A') dateSums[dIdx]++;
                    row += `<td class="status-${val}"><select onchange="updateAtt(${gIdx}, ${dIdx}, this.value)">
                        <option value="-" ${val==='-'?'selected':''}>-</option>
                        <option value="A" ${val==='A'?'selected':''}>A</option>
                        <option value="E" ${val==='E'?'selected':''}>E</option>
                        <option value="U" ${val==='U'?'selected':''}>U</option>
                    </select></td>`;
                });
                body.innerHTML += row + '</tr>';
            });

            // Footer
            footer.innerHTML = `<td>Summe (A)</td><td></td><td></td><td></td>` + 
                               state.specials.map(() => '<td></td>').join('') + 
                               dateSums.map(s => `<td>${s}</td>`).join('');

            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        }

        function addMember() {
            const inp = document.getElementById('nameInput');
            if(!inp.value.trim()) return;
            state.members.push({ name: inp.value.trim(), category: state.currentTab, attendance: new Array(state.dates.length).fill('-'), specialStates: new Array(state.specials.length).fill(false) });
            inp.value = ''; render(); inp.focus();
        }

        function rebuildCalendar(ask = true) {
            if(ask && !confirm("Kalender neu generieren? (L√∂scht Anwesenheiten)")) return;
            state.year = parseInt(document.getElementById('cfgYear').value);
            const ferien = state.ferienRaw.split('\n').filter(l => l.includes(' bis ')).map(l => l.split(' bis '));
            state.dates = [];
            let d = new Date(state.year, 0, 1);
            while(d.getDay() !== 2) d.setDate(d.getDate()+1);
            while(d.getFullYear() === state.year) {
                const s = d.toISOString().split('T')[0];
                if(!ferien.some(f => s >= f[0].trim() && s <= f[1].trim())) {
                    state.dates.push({ d: d.toLocaleDateString('de-DE').split('.').map(p => p.padStart(2,'0')).join('.'), t: "" });
                }
                d.setDate(d.getDate()+7);
            }
            state.members.forEach(m => m.attendance = new Array(state.dates.length).fill('-'));
            render(); if(ask) toggleConfig();
        }

        function toggleConfig() { const s = document.getElementById('configSection'); s.style.display = s.style.display === 'block' ? 'none' : 'block'; }
        function addManualDate() { const d = prompt("Datum (TT.MM.JJJJ):"); if(d) { state.dates.push({d, t:""}); state.members.forEach(m => m.attendance.push('-')); render(); } }
        function addSpecialColumn() { const t = prompt("Name der Liste:"); if(t) { state.specials.push(t); state.members.forEach(m => m.specialStates.push(false)); render(); } }
        function editDate(i, f, v) { state.dates[i][f] = v; render(); }
        function editSpec(i, v) { state.specials[i] = v; render(); }
        function updateAtt(mI, dI, v) { state.members[mI].attendance[dI] = v; render(); }
        function updateSpec(mI, sI, v) { state.members[mI].specialStates[sI] = v; localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
        function removeDate(i) { if(confirm("Termin l√∂schen?")) { state.dates.splice(i,1); state.members.forEach(m => m.attendance.splice(i,1)); render(); } }
        function removeSpecialCol(i) { if(confirm("Spalte l√∂schen?")) { state.specials.splice(i,1); state.members.forEach(m => m.specialStates.splice(i,1)); render(); } }
        function deleteMember(i) { if(confirm("Mitglied l√∂schen?")) { state.members.splice(i,1); render(); } }
        function resetAll() { if(confirm("Wirklich alles l√∂schen?")) { localStorage.removeItem(STORAGE_KEY); location.reload(); } }

        function createBackup() {
            const code = btoa(unescape(encodeURIComponent(JSON.stringify(state))));
            navigator.clipboard.writeText(code).then(() => alert("Backup-Code kopiert!"));
        }

        function importBackup() {
            const code = prompt("Code einf√ºgen:");
            if(code) { try { state = JSON.parse(decodeURIComponent(escape(atob(code)))); render(); alert("Import erfolgreich!"); } catch(e) { alert("Fehler beim Import!"); } }
        }

        function exportCSV() {
            let csv = "Kategorie;Name;A;E;U;" + state.specials.join(";") + ";" + state.dates.map(d => d.d).join(";") + "\r\n";
            state.members.forEach(m => {
                const s = [m.attendance.filter(a=>a==='A').length, m.attendance.filter(a=>a==='E').length, m.attendance.filter(a=>a==='U').length];
                csv += `${m.category};${m.name};${s[0]};${s[1]};${s[2]};${m.specialStates.map(v => v?'JA':'NEIN').join(';')};${m.attendance.join(';')}\r\n`;
            });
            const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `JF_Ehingen_Export.csv`; link.click();
        }

        window.onload = init;
    </script>
</body>
</html>
